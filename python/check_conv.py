#! /usr/bin/env python3
#
# check_conv.py: Script to check the SCF convergence of VASP single point
#                calculations, organized in folders frame*
#                as generated by vasp2trainset -md_traj=eval -mace
#
# Part of utils4VASP
#
# Author: Maximilian Bechtel, 2025 <maxi.bechtel@fau.de>
#

import os
import sys
import time

# List with all frames that have not converged yet
not_converged = []
# Check if the not converged frames should be restarted
restart = False
# Filename of file with last lines
filename = "not_converged.txt"

# Restart all frames that have not converged yet
def restart_frames(not_converged):
  for frame in not_converged:
    os.chdir(f"{frame}")

    os.system("cp ../INCAR .")
    os.system("cp ../slurm_script .")
    os.system(f"sed -i '7a\#SBATCH --job-name={frame}' slurm_script")
    os.system("sed -i '7d' slurm_script")
    os.system("sbatch slurm_script")

    os.chdir("..")

    time.sleep(1)  # Wait for one second until the next frame is restarted

# Get the last line of vasp.out in every frame directory
# The last line should contain 'F=' if SCF cycle converged properly

f = open(filename, 'w')

# Total number of directory frames
num_frames = int( os.popen("ls -F | grep / | wc -l").read() )

print(f"Checking convergence of {num_frames} frames ...")
print("")
for i in range(1, num_frames+1):
  os.chdir(f"frame{i}")

  # Check if file vasp.out exists
  vasp_exist = os.path.isfile("vasp.out")

  if vasp_exist:
    last_line = os.popen("tail -1 vasp.out").read()
    last_line = last_line.rstrip("\n")     # remove newline and the end
    last_line = last_line.lstrip()         # remove whitespaces at the beginning
    last_line_array = last_line.split()    # Split the string into a list

    # Check if file vasp.out is empty
    if len(last_line_array) == 0:
      not_converged.append(f"frame{i}")
      print(f"The file vasp.out is empty in frame{i}.")
      f.write(f"frame{i}: The file vasp.out is empty.\n")
    else:
      try:
        last_line_second = last_line_array[1]  # Get the 2nd element
      except IndexError as error:
        not_converged.append(f"frame{i}")
        print(f"An indeterminate error occured in frame{i}.")
        f.write(f"frame{i}: An indeterminate error occured.")

      # Check if SCF cycle converged, i.e. last_line_second should be 'F='
      if last_line_second != "F=":
        not_converged.append(f"frame{i}")
        f.write(f"frame{i}: " + last_line + "\n")
        print(f"The SCF cycle in frame{i} has not converged yet.")

  else:
    not_converged.append(f"frame{i}")
    f.write(f"frame{i}: The file vasp.out was not found.\n")
    print(f"The file vasp.out was not found in frame{i}.")

  os.chdir("..")

num_not_converged = len(not_converged)
if num_not_converged == 0:
  print("HURRAY! All frames converged!")
  sys.exit(0)

print("")
print(f"{num_not_converged} frames have not converged yet.")
print("Check the file " + filename + " for more information about the last lines.")
print("")

while True:
  print("Do you want to restart all of them? [y,n]")
  choice = input(">> ")
 
  if choice == 'y':
    restart = True 
    print(f"All {num_not_converged} frames will be restarted ...")
    break
  elif choice == 'n':
    print(f"The {num_not_converged} frames will not be restarted ...")
    break

# Restart the frames that have not converged
if restart:
  time.sleep(1)
  restart_frames(not_converged)

f.close()

